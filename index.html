<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="author" content="Eric K." />
    <meta
      name="description"
      content="Mallas curriculares FCFM Universidad de Chile"
    />
    <title>Malla FCFM</title>

    <script
      defer
      src="https://cdn.jsdelivr.net/npm/@alpinejs/persist@3.10.5/dist/cdn.min.js"
    ></script>
    <script
      defer
      src="https://cdn.jsdelivr.net/npm/alpinejs@3.10.5/dist/cdn.min.js"
    ></script>
    <script
      defer
      src="https://cdn.jsdelivr.net/npm/leader-line@1.0.7/leader-line.min.js"
      integrity="sha256-iKeFRzcz3iPVPlQcZXB/1wesZwIwnrY41rN7yaFvVB4="
      crossorigin="anonymous"
    ></script>

    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Lato:wght@400;900&display=swap"
      rel="stylesheet"
    />

    <link rel="stylesheet" href="css/main.css" />

    <script src="js/page.js" type="text/javascript"></script>
    <script src="js/malla.js" type="text/javascript"></script>

    <style>
      [x-cloak] {
        display: none !important;
      }
    </style>
  </head>

  <body
    x-data="{
            path: getPathname(),
            degrees: [],
            version: $persist('v5'),
            depthpre: $persist(1),
            depthpost: $persist(1),
            settingsOpen: false,
            showLines: $persist(true),
            showZeros: $persist(false),
            showCompacts: $persist(true),
            showPhases: $persist(true),
            redirect(el) {
                navigate(el);
                $dispatch('pushstate');
            },
            depthStep(value, increment) {
              return Math.max(0, Math.min(8, value + increment));
            }
        }"
    x-init="degrees = await (await fetch('/data/degrees.json')).json();"
    @popstate.window="path = getPathname();"
    @pushstate.window="path = getPathname();"
  >
    <nav>
      <div id="nav-left" class="nav-col">
        <template x-if="getPageState(path, degrees) == 1">
          <div class="breadcrumb">
            <a class="link" @click.prevent="redirect($el);" href="/">Mallas</a>
            <span x-text="`> ${degrees[path].code}`"></span>
          </div>
        </template>
      </div>

      <div id="nav-mid" class="nav-col">
        <span
          class="title"
          x-text="`Malla ${degrees[path].code}`"
          x-show="path in degrees"
          x-transition
        >
        </span>
        <a
          class="title ulink"
          x-text="'Mallas FCFM'"
          x-show="!(path in degrees)"
          href="/"
        >
        </a>
      </div>

      <div id="nav-right" class="nav-col">
        <button
          class="open-settings"
          @click="settingsOpen = !settingsOpen;"
          :class="settingsOpen ? 'open' : ''"
        >
          <img src="/images/icons/settings-gear-icon.svg" />
        </button>

        <ul
          class="settings"
          x-show="settingsOpen"
          @click.away="settingsOpen = false;"
          x-transition
        >
          <li class="setting-section">Propagación del arbol:</li>
          <li class="setting number-input">
            <label for="depthpre">↓ Requisitos:</label>
            <div class="setting-input">
              <button @click="depthpre = depthStep(depthpre, -1);">-</button>
              <input
                type="number"
                id="depthpre"
                name="depthpre"
                min="1"
                max="10"
                x-model.number="depthpre"
              />
              <button @click="depthpre = depthStep(depthpre, 1);">+</button>
            </div>
          </li>
          <li class="setting number-input">
            <label for="depthpost">↑ Desbloqueados:</label>
            <div class="setting-input">
              <button @click="depthpost = depthStep(depthpost, -1);">-</button>
              <input
                type="number"
                id="depthpost"
                name="depthpost"
                min="1"
                max="10"
                x-model.number="depthpost"
              />
              <button @click="depthpost = depthStep(depthpost, 1);">+</button>
            </div>
          </li>
          <hr />
          <li class="setting-section">Visualización:</li>
          <li class="setting">
            <span class="setting-label">↔ Flechas:</span>
            <label class="setting-input checkbox-input" for="showLines">
              <input
                type="checkbox"
                id="showLines"
                name="showLines"
                x-model="showLines"
              />
              <div class="slider"></div>
            </label>
          </li>
          <li class="setting">
            <span class="setting-label">Cursos 0 Creditos:</span>
            <label class="setting-input checkbox-input" for="showZeros">
              <input
                type="checkbox"
                id="showZeros"
                name="showZeros"
                x-model="showZeros"
              />
              <div class="slider"></div>
            </label>
          </li>
          <li class="setting">
            <span class="setting-label">Electivos compactos:</span>
            <label class="setting-input checkbox-input" for="showCompacts">
              <input
                type="checkbox"
                id="showCompacts"
                name="showCompacts"
                x-model="showCompacts"
              />
              <div class="slider"></div>
            </label>
          </li>
          <li class="setting">
            <span class="setting-label">Nombres de planes:</span>
            <label class="setting-input checkbox-input" for="showPhases">
              <input
                type="checkbox"
                id="showPhases"
                name="showPhases"
                x-model="showPhases"
              />
              <div class="slider"></div>
            </label>
          </li>
        </ul>
      </div>
    </nav>

    <main x-cloak>
      <template x-if="getPageState(path, degrees) == 0">
        <div class="card-grid">
          <template x-for="item in degrees">
            <a :href="`${item.code}`" @click.prevent="redirect($el);">
              <article class="card">
                <img
                  :src="`./images/splashes/${item.code}.jpg`"
                  class="card-image"
                />
                <div class="card-text">
                  <span class="card-title card-name" x-text="item.name"></span>
                  <span
                    class="card-title card-fullname"
                    x-text="item.fullName"
                  ></span>
                </div>
              </article>
            </a>
          </template>
        </div>
      </template>

      <template x-if="getPageState(path, degrees) == 1">
        <div id="interior">
          <template x-if="!('department' in degrees[path])">
            <div id="not-found">
              <h1>Perdón.</h1>
              <h2>Esta malla no se ha implementado aún.</h2>
            </div>
          </template>

          <template
            x-if="'department' in degrees[path]"
            x-data="{malla: {}}"
            x-init="malla = await (await fetch(`/data/${degrees[path].code}.json`)).json();"
          >
            <div id="malla">
              <template x-for="phase in malla[version]">
                <section class="phase">
                  <span
                    class="banner-title"
                    x-text="phase.name"
                    x-show="showPhases"
                    >
                  </span>
                  <div class="semesters">
                    <template x-for="semester in phase.semesters">
                      <section class="semester">
                        <span
                          class="banner-title"
                          x-text="semester.number"
                          :class="showPhases ? '' : 'horizontal-text'"
                        ></span>
                        <div class="courses">
                          <template x-for="(course, index) in semester.courses">
                            <div
                              class="course"
                              :id="index"
                              x-data="{
                                    prerequisites: course.prerequisites,
                                    postrequisites: course.postrequisites,
                                    element: $el,
                                    shown() {
                                      if (course.credits == 0 && !showZeros) {
                                        return false;
                                      } else if (course.type == 'compacted' && !showCompacts) {
                                        return false;
                                      } else if (course.type == 'compactable' && showCompacts) {
                                        return false;
                                      } else {
                                        return true;
                                      }
                                    },
                                    select(event) {
                                        courseSelected($data, event, showLines, depthpre, depthpost);
                                    }
                                }"
                              @mouseenter="select('mouseenter');"
                              @mouseleave="select('mouseleave');"
                              @click="select('click');"
                              :class="course.department"
                              x-show="shown()"
                              :data-prereqs="course.prerequisites"
                              :data-postreqs="course.postrequisites"
                            >
                              <div
                                class="course-bar"
                                x-show="shown()"
                              >
                                <span
                                  class="course-code"
                                  x-text="course.code"
                                ></span>
                                <span
                                  class="course-credits"
                                  x-text="course.credits"
                                ></span>
                              </div>
                              <div
                                class="course-body"
                                x-show="shown()"
                              >
                                <span
                                  class="course-name"
                                  x-text="course.name"
                                ></span>
                              </div>
                            </div>
                          </template>
                        </div>
                      </section>
                    </template>
                  </div>
                </section>
              </template>
            </div>
          </template>
        </div>
      </template>
    </main>

    <footer>
      <div class="footer-credit">
        <span>Página por:</span>
        <a class="link" href="https://eri.cl" target="_blank">Eric K.</a>
      </div>
      <div class="footer-links">
        <a
          class="link"
          href="https://github.com/Nyveon/malla-fcfm/issues"
          target="_blank"
          >Reportes/Sugerencias</a
        >
        <a
          class="link"
          href="https://github.com/Nyveon/malla-fcfm/"
          target="_blank"
          >
          <img src="/images/icons/github-icon.svg" />
        </a>
      </div>
    </footer>
  </body>
  <!-- Site by Eric K. -->
</html>
